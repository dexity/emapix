{% extends "base.html" %}

{% block header %}
<script type="text/javascript"
    src="http://maps.googleapis.com/maps/api/js?key=AIzaSyA85oDjeGmemRXYK5MfKfCM3RKVadnrHDk&sensor=false">
</script>
<script type="text/javascript">

    function pick_image()
    {
	
    }
    
    function submit_photo()
    {
	$("#submit_modal").modal();
    }
   
    $(document).ready(function(){
	{% if req %}
	var lat	= {{ req.location.lat }};
	var lon	= {{ req.location.lon }};
	var location = new google.maps.LatLng(lat, lon);
	var myOptions = {
	    center: location,
	    zoom: 13,
	    mapTypeId: google.maps.MapTypeId.ROADMAP,
	};
	map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
	marker	= new google.maps.Marker({
			position:  	new google.maps.LatLng(lat, lon),
			title:		"{{ req.description }}",
			map:		map
		    });
	$("#remove_link").click(function(e){
		e.preventDefault();
		$("#body_errors").html("");
		$("#remove_modal").modal();
	    });
	
	// Set events
	$("#delete_btn").click(function() {
	    url = $("#remove_link").attr("href");
	    $.post(url,
		{"csrfmiddlewaretoken": $("input[name=csrfmiddlewaretoken]").val()},
		function(data) {
		    try
		    {
			var res	= $.parseJSON(data);    // OK
			if (res["status"] == "ok")
			{
			    $("#remove_modal").modal("hide");
			    // Go to requests list
			    window.location.href = "/requests"
			}
			else
			{
			    $("#body_errors").html("result");
			}
		    }
		    catch (e)
		    {
			$("#body_errors").html(data);
		    }
		});
	});
	{% endif %}	
    });
</script>

{% endblock header %}

{% block content %}

{% if req %}
<style type="text/css">
  #map_canvas { width:460px; height:460px; }
</style>

<div class="pull-left"><h3>Request</h3></div>
<div class="e-alert pull-left">You can submit photo for this location</div>
<div class="clear_both"></div>
<div class="row">
    <div class="span6">
	{% if username|stringformat:"s" == req.user.username %}
	<img src="{{pic_url}}" width="460" height="460" />
        <!--<button class="btn btn-success" onclick="submit_photo()"><b>Submit Photo</b></button>-->
	<!-- Modal -->
	<div id="submit_modal" class="modal hide fade">
	    <div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3>Submit Photo</h3>
	    </div>
	    <div class="modal-body" id="submit_body">
		<div id="body_errors"></div>
		<div class="e-alert pull-left" style="margin-left: 0px; margin-bottom: 10px;">Please submit photo for this location!
		Photo can be up to 5Mb and in JPEG or PNG formats.
		</div>
		<input type="file" style="margin-bottom: 10px;"/>
		<!--<div class="clear_both"></div>
		<img src="/media/img/photo_large.png" width="300" height="300" />
		<div class="clear_both e-margin-bottom-10"></div>
		<button class="btn btn-success"><b>Crop Photo</b></button> -->
	    </div>
	</div>
	
	{% endif %}
        <div class="full-description" title="Description">{{ req.description }}</div>
	<div class="row">
	    <div class="span2">Approximate Address:</div>
	    {% include "misc/address.html" %}
	</div>
        <div class="e-request-info">
	    <div class="row">
		<div class="span2">Location:</div>
		<div>{{ req.location.lat }}, {{ req.location.lon }}</div>
	    </div>
	    <div class="row">
		<div class="span2">Requested by:</div>
		<a href="/user/{{ req.user.username }}">{{ req.user.username }}</a>
	    </div>
            <div class="row">
                <div class="span2">Date:</div>
                <div class="e-time" title="{{ utcdate }}">{{ hdate }}</div>
            </div>
        </div>
        <div class="row e-control-options">
            <div class="span3 pull-left">
		<a href="/submit/select/{{ req.resource }}" >Submit different photo</a>
	    </div>
	    {% csrf_token %}
            <div class="span3 pull-right">
		
		{% if username|stringformat:"s" == req.user.username %}
                <a href="/request/{{ req.resource }}/remove" class="red pull-right" id="remove_link">Remove Request</a>
		{% endif %}
            </div>
	    <div id="remove_modal" class="modal hide fade">
		<div class="modal-header"><h3>Delete Request</h3></div>
		<div class="modal-body">
		    <div id="body_errors"></div>
		    Are you sure you want to delete the request?
		</div>
		<div class="modal-footer">
		  <a href="#" class="btn btn-danger" id="delete_btn">Delete</a>
		  <a href="#" class="btn" data-dismiss="modal" >Close</a>
		</div>
	    </div>	    
        </div>
	<hr />
	<!-- XXX: Finish -->
        <div class="e-request-info">
	    <div class="row">
		<div class="span2">Status:</div>
		<span class="label label-success">Accepted</span>
	    </div>
	    <div class="row">
		<div class="span2">Accepted by:</div>
		<a href="/user/dexity">dexity</a>
	    </div>
            <div class="row">
                <div class="span2">Date:</div>
                <div class="e-time" title="">Aug 21, 2012 14:05</div>
            </div>    
	</div>
	<div class="full-description" title="Description">Here I'll leave my comment</div>
    </div>    
    <div class="span6"><div id="map_canvas"></div></div>
</div>
{% else %}
    <div class="row" id="message" onclick="fadeToMain()">
        <div class="span8 alert alert-error">
            Request is not found
            <br/>
        </div>
    </div>   
{% endif %}

{% endblock content %}