{% extends "base.html" %}

{% block content %}

<style type="text/css">
  #map_canvas { width:460px; height:460px; }
</style>

<div class="row">
    <div class="span5">
        <h3>{{req.description|slice:":35"}}{% if req.description|length > 35 %}...{% endif %}</h3>
    </div>
    <div class="span1">
        {% if is_open %}
        <div class="e-status-open pull-right">Open</div>
        {% else %}
        <div class="e-status-closed pull-right">Closed</div>
        {% endif %}
    </div>
</div>
<div class="clear_both"></div>
<div class="row">
    <div class="span6">
	{% if pic_url %}
	<img src="{{pic_url}}" />
        {% else %}
        <button class="btn btn-success" id="submit_photo"><b>Submit Photo</b></button>
	{% endif %}
        <div class="full-description" title="Description">{{ req.description }}</div>
	<div class="row">
	    <div class="span2">Approximate Address:</div>
	    {% include "misc/address.html" %}
	</div>
        <div class="e-request-info">
	    <div class="row">
		<div class="span2">Location:</div>
		<div>{{ req.location.lat }}, {{ req.location.lon }}</div>
	    </div>
	    <div class="row">
		<div class="span2">Requested:</div>
		<a href="/user/{{ req.user.username }}">{{ req.user.username }}</a>
                <div class="e-time" title="{{ utcdate }}">{{ hdate }}</div>
	    </div>
            {% if submitter %}
	    <div class="row">
		<div class="span2">Submitted:</div>
		<a href="/user/{{submitter.username}}">{{submitter.username}}</a>
                <div class="e-time" title="{{pic_utcdate}}">{{pic_hdate}}</div>
	    </div>
            {% endif %}
        </div>
        {% if pic_url or is_you %}
        <div class="row e-control-options">
            <div class="span3 pull-left">
                {% if is_open %}
                    <a href="#" id="edit_request">Edit Request</a><br />
                    {% if pic_url %}
                    <a href="#" id="submit_photo">Submit Different Photo</a><br />
                    {% endif %}
                    <a href="/request/{{req.resource}}/status/close/json" id="request_status">Close Request</a> <img src="/media/img/spinner_small.gif" id="close_spinner" style="display: none" class="e-spinner"/><br />
                {% else %}
                    <a href="/request/{{req.resource}}/status/open/json" id="request_status">Open Request</a> <img src="/media/img/spinner_small.gif" id="close_spinner" style="display: none" class="e-spinner"/><br />
                {% endif %}
            </div>
            <div class="span3 pull-right">
		{% if is_you %}
                {% if is_open %}
                    <a href="#" class="red" id="remove_photo">Remove Photo</a><br />
                {% endif %}
                <a href="/request/{{ req.resource }}/remove" class="red" id="remove_request">Remove Request</a><br />
		{% endif %}
            </div>
        </div>
        <div class="e-alert alert-error pull-left" style="display: none;" id="controls_error"></div>
        <div class="clearfix"></div>
        {% endif %}
        <div class="e-request-info">
            <div class="section-title">Comments
                <span class="badge badge-success e-section-badge" id="comments_badge">{{req.num_comments}}</span>
                <img src="/media/img/spinner_small.gif" id="comment_spinner" style="display: none" class="wait e-button-spinner pull-right"/>
            </div>
            <hr />
            <div id="comments"></div>
        </div>
    </div>    
    <div class="span6"><div id="map_canvas"></div></div>
</div>

<!-- Modals -->
<!-- Submit photo modal -->
<div id="submit_container">
    {% include "modals/submit.html" %}
</div>

<!-- Edit request modal -->
<div id="edit_modal" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Edit Request</h3>
    </div>
    <div class="modal-body"></div>
    <div class="modal-footer">
        <div class="e-alert e-alert-inline alert-error pull-left" style="display: none"></div>
        <img src="/media/img/spinner_small.gif" id="edit_spinner" style="display: none" class="e-button-spinner"/>
        <button class="btn btn-primary submit_form">Save Changes</button>
        <a href="#" data-dismiss="modal">Cancel</a>
    </div>
</div>

<!-- Remove photo modal -->
<div id="remove_photo_modal" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Remove Photo</h3>
    </div>
    <div class="modal-body">
        <div class="alert">Are you sure you want to remove the photo?</div>
    </div>
    <div class="modal-footer">
        <div class="e-alert-head e-alert-inline alert-error pull-left" style="display: none">Error messages Making some comments about this place</div>
        <img src="/media/img/spinner_small.gif" id="remove_photo_spinner" style="display: none" class="e-button-spinner"/>
        <button class="btn btn-primary" class="submit_form">Remove Photo</button>
        <a href="#" data-dismiss="modal">Cancel</a>
    </div>
</div>

<!-- General csrf token -->
{% csrf_token %}

<!-- Remove request modal -->
{% include "modals/delete_request.html" %}

{% endblock content %}

{% block footer %}
    
{% if is_you %}
<script src="/media/fileuploader/js/vendor/jquery.ui.widget.js"></script>
<script src="/media/fileuploader/js/misc/tmpl.js"></script>
<script src="/media/fileuploader/js/misc/load-image.min.js"></script>
<script src="/media/fileuploader/js/misc/canvas-to-blob.min.js"></script>
<script src="/media/fileuploader/js/jquery.fileupload.js"></script>
<script src="/media/fileuploader/js/jquery.fileupload-fp.js"></script>
<script src="/media/fileuploader/js/jquery.fileupload-ui.js"></script>
<script src="/media/fileuploader/js/locale.js"></script>
<script src="/media/jcrop/js/jquery.Jcrop.js"></script>
<script src="/media/js/submit_photo.js"></script>
<script src="/media/js/utils.js"></script>

{% endif %}

<script src="/media/js/paginator.js"></script>
<script src="/media/js/comments.js"></script>

<script type="text/javascript"
    src="http://maps.googleapis.com/maps/api/js?key=AIzaSyA85oDjeGmemRXYK5MfKfCM3RKVadnrHDk&sensor=false">
</script>

<script type="text/javascript">
    
    $(document).ready(function(){
	
        // Load comments
        var comments = COMM({
            "container":    "comments",
            "type":         "request",
            "base_url":     "/comments/json?request={{req.resource}}",
            "submit_id":    "submit_comment",
            "submit_base_url":  "/comments/add/json?request={{req.resource}}"
        });
        comments.load_comments();
        
        // Load map
	var lat	= "{{ req.location.lat }}";
	var lon	= "{{ req.location.lon }}";
	var location = new google.maps.LatLng(lat, lon);
	var myOptions = {
	    center: location,
	    zoom: 13,
            scrollwheel: false,
	    mapTypeId: google.maps.MapTypeId.ROADMAP,
	};
	var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
	var marker	= new google.maps.Marker({
			position:  	new google.maps.LatLng(lat, lon),
			title:		"{{ req.description }}",
			map:		map
		    });
        
        // Load photo submitter
        var sub    = PHOTOSUB({
            select_url: "/submit/select/{{req.resource}}",
            crop_url:   "/submit/crop/{{req.resource}}",
            create_url: "/submit/create/{{req.resource}}",
            crop_size:  460,
            max_size:   780,
            finished_callback:  function(){
                $("#submit_modal").modal("hide");
                // XXX: Make json request to replace image and metadata
                //	instead of reloading the page. Save requests to Google Map
                window.location.href = "/request/{{ req.resource }}";
            }
        });
        
        var update_status   = function(){
            // - Update status label
            // - Update link "Close request" <-> "Open request"
            // - Disable some of the links
            // > Need to reload the page?
            window.location.href = "/request/{{ req.resource }}";
        }
	
        $("#request_status").click(function(e){
            e.preventDefault();
            var url = $("#request_status").attr("href");    //"/request/{{req.resource}}/status/close/json";
            $.ajax({
                url:    url,
                type:   "POST",
                data:   {"csrfmiddlewaretoken": $("input[name=csrfmiddlewaretoken]").val()},
                beforeSend: function(){
                    $(".alert-error").hide();
                    $("#close_spinner").show();
                },
                success:    function(){
                    $("#close_spinner").hide();
                    update_status();
                },
                error:      function(jqXHR, textStatus, errorThrown){
                    $("#close_spinner").hide();
                    $("#controls_error").html(error_msg(jqXHR, textStatus, errorThrown));
                    $("#controls_error").show();    // XXX: Error needs to be displayed in the modal
                }
            });
            
        });
        
        // XXX: Show only if user is the owner
        // XXX: Refactor, see user.html
	// Set events
	$("#delete_btn").click(function() {
	    var url = $("#remove_request").attr("href");
	    $.post(url,
		{"csrfmiddlewaretoken": $("input[name=csrfmiddlewaretoken]").val()},
		function(data) {
		    try
		    {
			var res	= $.parseJSON(data);    // OK
			if (res["status"] == "ok") {
			    $("#remove_modal").modal("hide");
			    // Go to requests list
			    window.location.href = "/requests"
			} else {
			    $("#body_errors").html("result");
			}
		    }
		    catch (e)
		    {
			$("#body_errors").html(data);
		    }
		});
	});
	
        $("#edit_request").click(function(e) {
            e.preventDefault();
            var url = "/request/{{req.resource}}/edit/json";
            var submit_form = function(e){
                $.ajax({
                    url:    url,
                    type:   "POST",
                    data:   $("#edit_modal form").serialize(),
                    cache:  false,
                    beforeSend: function(){
                        $("#edit_modal .alert-error").hide();
                        $("#edit_spinner").show();
                    },
                    success:    function(data){
                        $("#edit_modal").modal("hide");
                        window.location.href = "/request/{{req.resource}}"  // XXX: Not efficient!
                    },
                    error:  function(jqXHR, textStatus, errorThrown){
                        $("#edit_spinner").hide();
                        $("#edit_modal .alert-error").html(error_msg(jqXHR, textStatus, errorThrown));
                        $("#edit_modal .alert-error").show();
                    }
                });
            }
            
            $.ajax({
                url:    url,
                type:   "GET",
                cache:  false,
                success:    function(data){
                    $("#edit_modal .modal-body").html(data.data);
                    $("#edit_modal").modal();
                    $("#edit_modal .submit_form").unbind()
                        .click(submit_form);
                },
                error:  function(jqXHR, textStatus, errorThrown){
                    $("#edit_modal .alert-error").html(error_msg(jqXHR, textStatus, errorThrown));
                }
            })
        });
        $("#remove_photo").click(function(e) {
            e.preventDefault();
            $("#remove_photo_modal").modal();
            $("#remove_photo_modal .submit_form").unbind()
                .click(function(e){
                    var url = "";
                    $.ajax({
                        url:    url,
                        type:   "POST",
                        data:   $("#edit_modal form").serialize(),
                        cache:  false,
                        beforeSend: function(){
                            $("#edit_modal .alert-error").hide();
                            $("#edit_spinner").show();
                        },
                        success:    function(data){
                            $("#edit_modal").modal("hide");
                            window.location.href = "/request/{{req.resource}}"  // XXX: Not efficient!
                        },
                        error:  function(jqXHR, textStatus, errorThrown){
                            $("#edit_spinner").hide();
                            $("#edit_modal .alert-error").html(error_msg(jqXHR, textStatus, errorThrown));
                            $("#edit_modal .alert-error").show();
                        }
                    });                    
                });
        });
        
        $("#remove_request").click(function(e) {
            e.preventDefault();
            $("#remove_modal").modal();
        });        
        
	$("#submit_photo").click(function(e) {
	    e.preventDefault();
	    sub.show_select();
	});

    });
</script>
    

{% endblock %}